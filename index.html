<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë‹¤ì¤‘ ì„¬ê´‘ ì‚¬ì§„ ìƒì„±ê¸° (ì¹´ë©”ë¼/ì—…ë¡œë“œ Â· ìë™êµ¬ê°„ Â· 10fps Â· 5ì´ˆ)</title>
  <style>
    :root{
      --primary:#6366f1; --secondary:#8b5cf6; --success:#10b981;
      --dark:#0f172a; --card:#1e293b; --text:#f1f5f9; --muted:#94a3b8; --border:#334155;
      --shadow:0 10px 30px rgba(0,0,0,.3);
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:linear-gradient(135deg,#0f172a,#1e293b);color:var(--text);min-height:100vh;line-height:1.6}
    .container{max-width:1120px;margin:0 auto;padding:20px}
    header{text-align:center;padding:34px 20px;background:linear-gradient(135deg,var(--primary),var(--secondary));border-radius:20px;margin-bottom:22px;box-shadow:var(--shadow)}
    header h1{font-size:2.1rem;margin-bottom:6px;text-shadow:0 2px 10px rgba(0,0,0,.25)}
    header .subtitle{font-size:1rem;color:rgba(255,255,255,.92);max-width:820px;margin:0 auto}
    main{display:flex;flex-direction:column;gap:16px}
    section{background:var(--card);border-radius:14px;padding:22px;box-shadow:var(--shadow);border:1px solid var(--border)}
    section h2{font-size:1.45rem;margin-bottom:14px;color:var(--primary)}
    section h3{font-size:1.2rem;margin-bottom:12px}
    .upload-area{border:3px dashed var(--border);border-radius:14px;padding:52px 26px;text-align:center;cursor:pointer;transition:all .25s;background:rgba(99,102,241,.05)}
    .upload-area:hover{border-color:var(--primary);background:rgba(99,102,241,.1);transform:translateY(-3px)}
    .upload-area.drag-over{border-color:var(--success);background:rgba(16,185,129,.1)}
    .upload-icon{width:62px;height:62px;margin:0 auto 14px;color:var(--primary)}
    .upload-area h3{font-size:1.35rem;margin-bottom:6px}
    .upload-area p{color:var(--muted);font-size:.95rem;margin:2px 0}
    .video-preview{text-align:center}
    .video-preview video{max-width:100%;max-height:360px;border-radius:10px;box-shadow:0 5px 20px rgba(0,0,0,.4);margin-bottom:12px}
    .video-info{display:flex;flex-direction:column;gap:10px;align-items:center}
    .video-info p{color:var(--muted)}
    .settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-bottom:16px}
    .setting-item{display:flex;flex-direction:column;gap:7px}
    .setting-item label{font-weight:650;font-size:.92rem}
    .setting-item input[type=number], .setting-item select{
      padding:10px 12px;border:2px solid var(--border);border-radius:8px;background:var(--dark);color:var(--text);
      font-size:.95rem;transition:all .2s
    }
    .setting-item input:focus, .setting-item select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(99,102,241,.2)}
    .setting-item input[type=range]{width:100%;height:7px;border-radius:4px;background:var(--dark);outline:none;-webkit-appearance:none}
    .setting-item input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--primary);cursor:pointer}
    .desc{font-size:.82rem;color:var(--muted)}
    .slider-val{font-weight:800;color:var(--primary)}
    .btn{padding:12px 28px;border:none;border-radius:10px;font-size:1rem;font-weight:650;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    .btn:hover{transform:translateY(-2px);box-shadow:0 5px 18px rgba(0,0,0,.28)}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;width:100%;font-size:1.08rem;padding:16px}
    .btn-secondary{background:var(--dark);color:var(--text);border:2px solid var(--border)}
    .btn-secondary:hover{border-color:var(--primary)}
    .btn-success{background:var(--success);color:#fff}
    .btn-success:hover{background:#059669}
    .progress-bar{width:100%;height:24px;background:var(--dark);border-radius:13px;overflow:hidden;margin-bottom:8px}
    .progress-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--primary),var(--secondary));border-radius:13px;transition:width .2s;position:relative;overflow:hidden}
    .progress-fill::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.22),transparent);animation:shimmer 1.8s infinite}
    @keyframes shimmer{from{transform:translateX(-100%)}to{transform:translateX(100%)}}
    .progress-text{text-align:center;font-size:.95rem;color:var(--muted)}
    .compare{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px}
    .compare-item{text-align:center}
    .compare-item p{font-size:.85rem;color:var(--muted);margin-bottom:6px}
    .compare-item canvas{max-width:100%;border-radius:8px;border:1px solid var(--border)}
    .result-actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .result-actions .btn{flex:1;min-width:160px;max-width:260px}
    .hintbox{margin-top:10px;padding:12px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--muted);font-size:.92rem}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    footer{text-align:center;padding:22px 10px;margin-top:18px;color:var(--muted);border-top:1px solid var(--border)}
    @media(max-width:720px){ header h1{font-size:1.6rem} section{padding:16px} .compare{grid-template-columns:1fr} .result-actions{flex-direction:column} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>âœ¨ ë‹¤ì¤‘ ì„¬ê´‘ ì‚¬ì§„ ìƒì„±ê¸°</h1>
      <p class="subtitle">
        <b>ì›€ì§ì„ì´ ì‹œì‘ë˜ëŠ” êµ¬ê°„ì„ ìë™ íƒì§€</b>í•œ ë’¤, ê·¸ êµ¬ê°„ì—ì„œë§Œ <b>1ì´ˆë‹¹ 10ì»·</b>ìœ¼ë¡œ í”„ë ˆì„ì„ ë½‘ì•„ (ìµœëŒ€ 5ì´ˆ)
        <b>ë°°ê²½ì€ ê·¸ëŒ€ë¡œ</b> ë‘ê³  <b>ì›€ì§ì´ëŠ” ë¬¼ì²´ë§Œ</b> í•œ ì¥ì— í•©ì„±í•©ë‹ˆë‹¤.
      </p>
    </header>

    <main>
      <!-- ì—…ë¡œë“œ -->
      <section>
        <div class="upload-area" id="uploadArea">
          <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          <h3>ë™ì˜ìƒì„ ì—…ë¡œë“œí•˜ì„¸ìš”</h3>
          <p>í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸ ì•¤ ë“œë¡­</p>
          <p>MP4, MOV, WebM ì§€ì›</p>
          <p style="margin-top:10px;"><button class="btn btn-secondary" id="cameraBtn" type="button">ğŸ“· ì¹´ë©”ë¼ë¡œ 5ì´ˆ ì´¬ì˜</button></p>
          <input type="file" id="videoInput" accept="video/*" hidden />
        </div>

        <div class="video-preview" id="videoPreview" style="display:none;">
          <video id="previewVideo" controls playsinline></video>
          <div class="video-info">
            <p id="videoFileName"></p>
            <button class="btn btn-secondary" id="changeVideoBtn">ë‹¤ë¥¸ ë™ì˜ìƒ ì„ íƒ</button>
          </div>
        </div>
      </section>

      <!-- ì„¤ì • -->
      <section id="settingsSection" style="display:none;">
        <h2>ì„¤ì •</h2>
        <div class="settings-grid">
          <div class="setting-item">
            <label>ì´ˆë‹¹ ì¶”ì¶œ ì»· ìˆ˜ (FPS)</label>
            <input type="number" id="fpsExtract" value="20" min="5" max="60" />
            <span class="desc">ì›€ì§ì„ êµ¬ê°„ì—ì„œë§Œ ì ìš© (ê¸°ë³¸ 20fps)</span>
          </div>

          <div class="setting-item">
            <label>ì›€ì§ì„ íƒì§€ ë¯¼ê°ë„ <span class="slider-val" id="motionVal">18</span></label>
            <input type="range" id="motionScoreThr" min="8" max="45" value="18" />
            <span class="desc">ë‚®ì„ìˆ˜ë¡ ë¯¼ê°(í”ë“¤ë¦¼ë„ íƒì§€) / ë†’ì„ìˆ˜ë¡ í° ì›€ì§ì„ë§Œ</span>
          </div>

          <div class="setting-item">
            <label>ì›€ì§ì„ íƒì§€ ìƒ˜í”Œë§ (fps)</label>
            <input type="number" id="detectFps" value="5" min="2" max="12" />
            <span class="desc">ì›€ì§ì„ êµ¬ê°„ ì°¾ëŠ” ì†ë„/ì •í™•ë„ (ê¸°ë³¸ 5fps)</span>
          </div>

          <div class="setting-item">
            <label>ë°°ê²½ í•©ì„± ë°©ì‹</label>
            <select id="bgMode">
              <option value="first">ì²« í”„ë ˆì„ì„ ë°°ê²½ìœ¼ë¡œ</option>
              <option value="median" selected>ì¤‘ì•™ê°’ ë°°ê²½ ì¶”ì • (ê¶Œì¥)</option>
              <option value="last">ë§ˆì§€ë§‰ í”„ë ˆì„ì„ ë°°ê²½ìœ¼ë¡œ</option>
            </select>
            <span class="desc">ì¤‘ì•™ê°’: ì›€ì§ì´ëŠ” ë¬¼ì²´ê°€ ì‚¬ë¼ì§„ ë°°ê²½ì„ ì¶”ì •</span>
          </div>

          <div class="setting-item">
            <label>ë°°ê²½ ì¶”ì • ìƒ˜í”Œë§ ê°„ê²©</label>
            <input type="number" id="bgStride" value="2" min="1" max="10" />
            <span class="desc">2ë©´ 2í”„ë ˆì„ë§ˆë‹¤ 1ì¥ë§Œ ì‚¬ìš©(ì†ë„â†‘). 1ì´ë©´ ì „ë¶€ ì‚¬ìš©(ì •í™•ë„â†‘)</span>
          </div>

          <div class="setting-item">
            <label>ì›€ì§ì„ í•©ì„± ì„ê³„ê°’ <span class="slider-val" id="thrVal">25</span></label>
            <input type="range" id="threshold" min="5" max="100" value="25" />
            <span class="desc">ë‚®ì„ìˆ˜ë¡ ë¯¼ê° / ë†’ì„ìˆ˜ë¡ í° ì°¨ì´ë§Œ í•©ì„±</span>
          </div>

          <div class="setting-item">
            <label>ë¬¼ì²´ í•©ì„± ë°©ì‹</label>
            <select id="blendMode">
              <option value="copy" selected>ê·¸ëŒ€ë¡œ ë®ì–´ì“°ê¸° (ì„ ëª…)</option>
              <option value="lighten">ë°ì€ í”½ì…€ ìš°ì„  (Lighten)</option>
              <option value="darken">ì–´ë‘ìš´ í”½ì…€ ìš°ì„  (Darken)</option>
            </select>
            <span class="desc">ë°°ê²½ ìœ„ì— ë¬¼ì²´ í”½ì…€ì„ ì˜¬ë¦¬ëŠ” ë°©ì‹</span>
          </div>

          <div class="setting-item">
            <label>ìµœëŒ€ ì¶”ì¶œ í”„ë ˆì„ (ì„±ëŠ¥ ë³´í˜¸)</label>
            <input type="number" id="maxFrames" value="800" min="100" max="5000" />
            <span class="desc">ë„ˆë¬´ ê¸´ ì˜ìƒ ê³¼ë¶€í•˜ ë°©ì§€ (ê¸¸ë©´ í¬ê²Œ ì˜¬ë¦¬ì„¸ìš”)</span>
          </div>
        </div>

        <button class="btn btn-primary" id="generateBtn">ğŸ¨ ë‹¤ì¤‘ ì„¬ê´‘ ì‚¬ì§„ ìƒì„±</button>

        <div class="hintbox">
          âœ… íë¦„: <span class="mono">ì›€ì§ì„ êµ¬ê°„ ìë™ íƒì§€ â†’ (ê·¸ êµ¬ê°„ë§Œ) 10fps ì¶”ì¶œ â†’ ì¤‘ì•™ê°’ ë°°ê²½ ì¶”ì • â†’ ì›€ì§ì´ëŠ” ë¬¼ì²´ í•©ì„±</span><br/>
          âœ… â€œì²˜ìŒ/ë ì •ì§€ êµ¬ê°„â€ì€ ìë™ìœ¼ë¡œ ì œì™¸ë©ë‹ˆë‹¤.
        </div>
      </section>

      <!-- ì§„í–‰ -->
      <section id="progressSection" style="display:none;">
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        <p class="progress-text" id="progressText">ì¤€ë¹„ ì¤‘...</p>
      </section>

      <!-- ê²°ê³¼ -->
      <section id="resultSection" style="display:none;">
        <h2>âœ¨ ê²°ê³¼</h2>
        <div class="compare">
          <div class="compare-item">
            <p>ì¶”ì¶œëœ ë°°ê²½</p>
            <canvas id="bgCanvas"></canvas>
          </div>
          <div class="compare-item">
            <p>ë‹¤ì¤‘ ì„¬ê´‘ í•©ì„± ê²°ê³¼</p>
            <canvas id="resultCanvas"></canvas>
          </div>
        </div>

        <div class="result-actions">
          <button class="btn btn-success" id="downloadBtn">ğŸ’¾ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</button>
          <button class="btn btn-secondary" id="downloadBgBtn">ğŸ“· ë°°ê²½ë§Œ ë‹¤ìš´ë¡œë“œ</button>
          <button class="btn btn-secondary" id="resetBtn">ğŸ”„ ìƒˆë¡œ ë§Œë“¤ê¸°</button>
        </div>

        <div class="hintbox" id="motionInfo" style="margin-top:12px;"></div>
      </section>
    </main>

    <footer>Â© 2026 ë‹¤ì¤‘ ì„¬ê´‘ ì‚¬ì§„ ìƒì„±ê¸° | ëª¨ë“  ì²˜ë¦¬ëŠ” ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤</footer>
  </div>

  <canvas id="hiddenCanvas" style="display:none;"></canvas>

  <script>
    class StrobeGenerator {
      constructor() {
        this.frames = [];
        this.thumbUrls = [];
        this.bgImageData = null;
        this.init();
      }

      init() {
        this.uploadArea   = document.getElementById('uploadArea');
        this.videoInput   = document.getElementById('videoInput');
        this.cameraBtn   = document.getElementById('cameraBtn');
        this.videoPreview = document.getElementById('videoPreview');
        this.previewVideo = document.getElementById('previewVideo');
        this.hiddenCanvas = document.getElementById('hiddenCanvas');
        this.bgCanvas     = document.getElementById('bgCanvas');
        this.resultCanvas = document.getElementById('resultCanvas');
        this.setupEvents();
      }

      setupEvents() {
        this.uploadArea.addEventListener('click', () => this.videoInput.click());
        this.uploadArea.addEventListener('dragover', e => { e.preventDefault(); this.uploadArea.classList.add('drag-over'); });
        this.uploadArea.addEventListener('dragleave', () => this.uploadArea.classList.remove('drag-over'));
        this.uploadArea.addEventListener('drop', e => {
          e.preventDefault(); this.uploadArea.classList.remove('drag-over');
          const f = e.dataTransfer.files[0];
          if (f && f.type.startsWith('video/')) this.loadVideo(f);
        });
        this.videoInput.addEventListener('change', e => { if (e.target.files[0]) this.loadVideo(e.target.files[0]); });

        this.cameraBtn.addEventListener('click', (e) => { e.stopPropagation(); this.captureFromCamera(); });

        document.getElementById('changeVideoBtn').addEventListener('click', () => this.resetUpload());
        document.getElementById('generateBtn').addEventListener('click', () => this.generate());
        document.getElementById('downloadBtn').addEventListener('click', () => this.download(this.resultCanvas, 'strobe'));
        document.getElementById('downloadBgBtn').addEventListener('click', () => this.download(this.bgCanvas, 'background'));
        document.getElementById('resetBtn').addEventListener('click', () => this.resetResult());

        document.getElementById('threshold').addEventListener('input', e => {
          document.getElementById('thrVal').textContent = e.target.value;
        });
        document.getElementById('motionScoreThr').addEventListener('input', e => {
          document.getElementById('motionVal').textContent = e.target.value;
        });
      }

      async captureFromCamera() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ì¹´ë©”ë¼ ì´¬ì˜ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
        }
        if (typeof MediaRecorder === 'undefined') {
          alert('ì´ ë¸Œë¼ìš°ì €ëŠ” MediaRecorderë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Chrome/Edge ê¶Œì¥)');
          return;
        }

        // UI ì „í™˜(ê¸°ì¡´ ë ˆì´ì•„ì›ƒ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
        this.uploadArea.parentElement.style.display = 'none';
        this.videoPreview.style.display = 'block';
        document.getElementById('settingsSection').style.display = 'block';
        document.getElementById('videoFileName').textContent = 'íŒŒì¼ëª…: (ì¹´ë©”ë¼ ì´¬ì˜ 5ì´ˆ)';
        this.previewVideo.controls = false;

        let stream = null;
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
            audio: false
          });
        } catch (e) {
          alert('ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: ' + e.message);
          // UI ë³µêµ¬
          this.resetUpload();
          return;
        }

        // ë¼ì´ë¸Œ í”„ë¦¬ë·°
        this.previewVideo.srcObject = stream;
        try { await this.previewVideo.play(); } catch {}

        // 5ì´ˆ ì´¬ì˜
        const chunks = [];
        const rec = new MediaRecorder(stream, { mimeType: MediaRecorder.isTypeSupported('video/webm;codecs=vp9') ? 'video/webm;codecs=vp9' : 'video/webm' });

        rec.ondataavailable = (ev) => { if (ev.data && ev.data.size > 0) chunks.push(ev.data); };

        const done = new Promise((resolve) => {
          rec.onstop = () => resolve();
        });

        rec.start();

        // ì§„í–‰ í‘œì‹œ
        document.getElementById('progressSection').style.display = 'block';
        this.setProgress(0, 'ì¹´ë©”ë¼ ì´¬ì˜ ì¤‘... (5ì´ˆ)');
        const start = Date.now();
        const tick = setInterval(() => {
          const t = Math.min(1, (Date.now() - start) / 5000);
          this.setProgress(Math.round(t * 20), `ì¹´ë©”ë¼ ì´¬ì˜ ì¤‘... (${(5 - 5*t).toFixed(1)}s ë‚¨ìŒ)`);
        }, 100);

        setTimeout(() => {
          try { rec.stop(); } catch {}
        }, 5000);

        await done;
        clearInterval(tick);
        this.setProgress(20, 'ì´¬ì˜ ì™„ë£Œ â€” ë¶„ì„ ì¤€ë¹„ ì¤‘...');
        await this.tick();

        // ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ
        try { stream.getTracks().forEach(t => t.stop()); } catch {}

        // blob -> ì—…ë¡œë“œ ì˜ìƒì²˜ëŸ¼ ì²˜ë¦¬
        const blob = new Blob(chunks, { type: rec.mimeType || 'video/webm' });
        const url = URL.createObjectURL(blob);

        this.previewVideo.pause();
        this.previewVideo.srcObject = null;
        this.previewVideo.src = url;
        this.previewVideo.controls = true;

        // metadata ë¡œë“œ ê¸°ë‹¤ë¦¼
        await new Promise((res) => this.previewVideo.addEventListener('loadedmetadata', res, { once:true }));

        document.getElementById('progressSection').style.display = 'none';
      }

      loadVideo(file) {
        this.previewVideo.src = URL.createObjectURL(file);
        document.getElementById('videoFileName').textContent = `íŒŒì¼ëª…: ${file.name}`;
        this.uploadArea.parentElement.style.display = 'none';
        this.videoPreview.style.display = 'block';
        document.getElementById('settingsSection').style.display = 'block';
      }

      resetUpload() {
        this.videoInput.value = '';
        this.previewVideo.src = '';
        this.uploadArea.parentElement.style.display = 'block';
        this.videoPreview.style.display = 'none';
        ['settingsSection','progressSection','resultSection'].forEach(id => document.getElementById(id).style.display = 'none');
      }

      resetResult() {
        this.frames = [];
        this.thumbUrls = [];
        this.bgImageData = null;
        document.getElementById('resultSection').style.display = 'none';
        document.getElementById('settingsSection').style.display = 'block';
        document.getElementById('motionInfo').innerHTML = '';
      }

      async generate() {
        // â­ ê³ ì • ì„¤ì •: 1ì´ˆë‹¹ 10ì»·(10fps)ë¡œ ì¶”ì¶œ (UI êµ¬ì¡°ëŠ” ê·¸ëŒ€ë¡œ)
        const fpsEl = document.getElementById('fpsExtract');
        if (fpsEl) fpsEl.value = 10;
        const fpsExtract     = parseInt(document.getElementById('fpsExtract').value, 10);
        const threshold      = parseInt(document.getElementById('threshold').value, 10);
        const bgMode         = document.getElementById('bgMode').value;
        const blendMode      = document.getElementById('blendMode').value;
        const bgStride       = parseInt(document.getElementById('bgStride').value, 10);
        const detectFps      = parseFloat(document.getElementById('detectFps').value);
        const motionScoreThr = parseFloat(document.getElementById('motionScoreThr').value);
        const maxFrames      = parseInt(document.getElementById('maxFrames').value, 10);

        document.getElementById('progressSection').style.display = 'block';
        document.getElementById('resultSection').style.display = 'none';

        try {
          // 0) ì›€ì§ì„ êµ¬ê°„ íƒì§€
          this.setProgress(0, 'ì›€ì§ì„ êµ¬ê°„ ë¶„ì„ ì¤‘...');
          const win = await this.detectMotionWindow(this.previewVideo.src, detectFps, motionScoreThr, 2);

          // â­ 5ì´ˆ ì œí•œ: ì›€ì§ì„ ì‹œì‘ ì‹œì ë¶€í„° ìµœëŒ€ 5ì´ˆë§Œ ì‚¬ìš©
          const limitedEnd = Math.min(win.endTime, win.startTime + 5);
          const winLimited = { ...win, endTime: limitedEnd, duration: Math.max(0, limitedEnd - win.startTime), note: win.note + '+limit5s' };

          // 1) êµ¬ê°„ë§Œ fpsë¡œ í”„ë ˆì„ ì¶”ì¶œ
          this.setProgress(6, `í”„ë ˆì„ ì¶”ì¶œ ì¤€ë¹„... (${winLimited.startTime.toFixed(2)}s ~ ${winLimited.endTime.toFixed(2)}s)`);
          const { frames, usedStart, usedEnd } =
            await this.extractFramesByFps(this.previewVideo.src, fpsExtract, winLimited.startTime, winLimited.endTime, maxFrames);

          this.frames = frames;

          // 2) ë°°ê²½ ì¶”ì • (stride ì ìš©)
          this.setProgress(58, 'ë°°ê²½ ì¶”ì • ì¤‘...');
          const framesForBg = this.strideFrames(frames, bgStride);
          this.bgImageData = await this.estimateBackground(framesForBg, bgMode);

          this.bgCanvas.width = this.bgImageData.width;
          this.bgCanvas.height = this.bgImageData.height;
          this.bgCanvas.getContext('2d', { willReadFrequently:true }).putImageData(this.bgImageData, 0, 0);

          // 3) ë‹¤ì¤‘ ì„¬ê´‘ í•©ì„±
          this.setProgress(70, 'ì›€ì§ì´ëŠ” ë¬¼ì²´ í•©ì„± ì¤‘...');
          await this.compositeStrobe(frames, this.bgImageData, threshold, blendMode);

          this.setProgress(100, 'ì™„ë£Œ!');
          document.getElementById('progressSection').style.display = 'none';
          document.getElementById('resultSection').style.display = 'block';

          const info = document.getElementById('motionInfo');
          info.innerHTML =
            `ğŸŸ¢ ì›€ì§ì„ êµ¬ê°„(ìë™, 5ì´ˆ ì œí•œ ì ìš©): <b>${winLimited.startTime.toFixed(2)}s ~ ${winLimited.endTime.toFixed(2)}s</b> (ë©”ëª¨: <span class="mono">${win.note}</span>)<br/>` +
            `ğŸŸ£ ì‹¤ì œ ì¶”ì¶œ êµ¬ê°„: <b>${usedStart.toFixed(2)}s ~ ${usedEnd.toFixed(2)}s</b><br/>` +
            `ğŸŸ¡ ì¶”ì¶œ: <b>${frames.length}ì»·</b> (fps=${fpsExtract}) / ë°°ê²½ ì¶”ì • í”„ë ˆì„: <b>${framesForBg.length}ì»·</b> (stride=${bgStride})`;

        } catch (err) {
          console.error(err);
          alert('ì˜¤ë¥˜: ' + err.message);
          document.getElementById('progressSection').style.display = 'none';
        }
      }

      strideFrames(frames, stride) {
        if (!stride || stride <= 1) return frames;
        const out = [];
        for (let i = 0; i < frames.length; i += stride) out.push(frames[i]);
        return out.length ? out : frames;
      }

      // =========================
      //  ì›€ì§ì„ êµ¬ê°„ ìë™ íƒì§€
      // =========================
      async detectMotionWindow(videoSrc, detectFps=5, motionScoreThr=18, stableNeed=2) {
        const video = document.createElement('video');
        video.src = videoSrc;
        video.muted = true;

        await new Promise((res, rej) => {
          video.addEventListener('loadedmetadata', res, { once:true });
          video.addEventListener('error', () => rej(new Error('ë™ì˜ìƒ ë¡œë“œ ì‹¤íŒ¨')), { once:true });
        });

        const dur = video.duration;
        const step = 1 / Math.max(1, detectFps);

        let prev = await this.sampleFrameAt(video, 0);
        let started = false;
        let startTime = 0;
        let endTime = dur;

        let stableCount = 0;
        let lastMovingTime = 0;

        const totalSteps = Math.max(1, Math.ceil(dur / step));

        for (let si = 1; si <= totalSteps; si++) {
          const t = Math.min(dur, si * step);
          const cur = await this.sampleFrameAt(video, t);

          const score = this.frameDiffScore(prev, cur);

          if (!started) {
            if (score >= motionScoreThr) {
              started = true;
              startTime = Math.max(0, t - step); // ì‚´ì§ ì•ë‹¹ê¹€
              lastMovingTime = t;
              stableCount = 0;
            }
          } else {
            if (score >= motionScoreThr) {
              lastMovingTime = t;
              stableCount = 0;
            } else {
              stableCount++;
              if (stableCount >= stableNeed) {
                endTime = lastMovingTime;
                break;
              }
            }
          }

          prev = cur;

          if (si % 4 === 0) {
            const pct = Math.min(5, Math.round((si / totalSteps) * 5));
            this.setProgress(pct, `ì›€ì§ì„ êµ¬ê°„ ë¶„ì„ ì¤‘... (${Math.round((si/totalSteps)*100)}%)`);
            await this.tick();
          }
        }

        if (started && endTime === dur) endTime = Math.min(dur, lastMovingTime);
        if (!started) return { startTime: 0, endTime: dur, duration: dur, note: 'motion_not_found(ì „ì²´ ì‚¬ìš©)' };
        if (endTime - startTime < 0.2) return { startTime: 0, endTime: dur, duration: dur, note: 'motion_too_short(ì „ì²´ ì‚¬ìš©)' };

        return { startTime, endTime, duration: endTime - startTime, note: 'ok' };
      }

      async sampleFrameAt(video, t, w=160, h=90) {
        return new Promise((resolve) => {
          const canvas = this.hiddenCanvas;
          const ctx = canvas.getContext('2d', { willReadFrequently: true });

          const onSeeked = () => {
            video.removeEventListener('seeked', onSeeked);
            canvas.width = w; canvas.height = h;
            ctx.drawImage(video, 0, 0, w, h);
            resolve(ctx.getImageData(0, 0, w, h));
          };

          video.addEventListener('seeked', onSeeked);
          video.currentTime = t;
        });
      }

      frameDiffScore(a, b) {
        const ad = a.data, bd = b.data;
        let sum = 0;
        for (let i = 0; i < ad.length; i += 4) {
          sum += Math.abs(ad[i]-bd[i]) + Math.abs(ad[i+1]-bd[i+1]) + Math.abs(ad[i+2]-bd[i+2]);
        }
        return sum / (ad.length / 4);
      }

      // =========================
      //  fps ê¸°ë°˜ í”„ë ˆì„ ì¶”ì¶œ
      // =========================
      extractFramesByFps(videoSrc, fps, startTime, endTime, maxFrames=800) {
        return new Promise((resolve, reject) => {
          const video = document.createElement('video');
          video.src = videoSrc;
          video.muted = true;

          const frames = [];
          let idx = 0;

          video.addEventListener('loadedmetadata', () => {
            const dur = video.duration;
            const s = Math.max(0, startTime);
            const e = Math.min(dur, endTime);

            const interval = 1 / Math.max(1, fps);
            let frameCount = Math.max(1, Math.floor((e - s) * fps));

            if (frameCount > maxFrames) frameCount = maxFrames;

            const usedEnd = Math.min(e, s + frameCount * interval);

            const canvas = this.hiddenCanvas;
            const ctx = canvas.getContext('2d', { willReadFrequently: true });

            const seek = () => {
              if (idx >= frameCount) {
                resolve({ frames, usedStart: s, usedEnd });
                return;
              }
              video.currentTime = s + idx * interval;
            };

            video.addEventListener('seeked', () => {
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              ctx.drawImage(video, 0, 0);
              frames.push(ctx.getImageData(0, 0, canvas.width, canvas.height));

              idx++;
              this.setProgress(Math.min(55, Math.round((idx / frameCount) * 55)),
                `í”„ë ˆì„ ì¶”ì¶œ ì¤‘... (${idx} / ${frameCount})`);
              seek();
            });

            seek();
          });

          video.addEventListener('error', () => reject(new Error('ë™ì˜ìƒ ë¡œë“œ ì‹¤íŒ¨')));
        });
      }

      // =========================
      //  ë°°ê²½ ì¶”ì •
      // =========================
      async estimateBackground(frames, mode) {
        const N = frames.length;
        const W = frames[0].width;
        const H = frames[0].height;
        const out = new Uint8ClampedArray(W * H * 4);

        if (mode === 'first') {
          out.set(frames[0].data);
          return new ImageData(out, W, H);
        }
        if (mode === 'last') {
          out.set(frames[N-1].data);
          return new ImageData(out, W, H);
        }

        const mid = Math.floor(N / 2);
        const buf = new Uint8Array(N);

        for (let i = 0; i < W * H; i++) {
          const p = i * 4;
          for (let c = 0; c < 3; c++) {
            for (let f = 0; f < N; f++) buf[f] = frames[f].data[p + c];
            out[p + c] = this.quickSelect(buf, N, mid);
          }
          out[p + 3] = 255;

          if (i % 50000 === 0) {
            this.setProgress(58 + Math.round((i / (W * H)) * 10),
              `ë°°ê²½ ì¶”ì • ì¤‘... ${Math.round((i / (W * H)) * 100)}%`);
            await this.tick();
          }
        }
        return new ImageData(out, W, H);
      }

      quickSelect(arr, n, k) {
        const a = arr.slice(0, n).sort((x, y) => x - y);
        return a[k];
      }

      // =========================
      //  ë‹¤ì¤‘ ì„¬ê´‘ í•©ì„±
      // =========================
      async compositeStrobe(frames, bgData, threshold, blendMode) {
        const N = frames.length;
        const W = bgData.width;
        const H = bgData.height;
        const bg = bgData.data;

        const out = new Uint8ClampedArray(bg);

        for (let f = 0; f < N; f++) {
          const fd = frames[f].data;

          for (let i = 0; i < W * H; i++) {
            const p = i * 4;

            const dr = Math.abs(fd[p]   - bg[p]);
            const dg = Math.abs(fd[p+1] - bg[p+1]);
            const db = Math.abs(fd[p+2] - bg[p+2]);
            const diff = Math.max(dr, dg, db);

            if (diff > threshold) {
              if (blendMode === 'copy') {
                out[p] = fd[p]; out[p+1] = fd[p+1]; out[p+2] = fd[p+2];
              } else if (blendMode === 'lighten') {
                out[p] = Math.max(out[p], fd[p]);
                out[p+1] = Math.max(out[p+1], fd[p+1]);
                out[p+2] = Math.max(out[p+2], fd[p+2]);
              } else {
                out[p] = Math.min(out[p], fd[p]);
                out[p+1] = Math.min(out[p+1], fd[p+1]);
                out[p+2] = Math.min(out[p+2], fd[p+2]);
              }
              out[p+3] = 255;
            }
          }

          this.setProgress(70 + Math.round((f / N) * 28),
            `ë¬¼ì²´ í•©ì„± ì¤‘... (${f + 1} / ${N})`);
          if (f % 5 === 0) await this.tick();
        }

        this.resultCanvas.width = W;
        this.resultCanvas.height = H;
        this.resultCanvas.getContext('2d', { willReadFrequently:true })
          .putImageData(new ImageData(out, W, H), 0, 0);
      }

      tick(){ return new Promise(r => setTimeout(r, 0)); }

      setProgress(pct, text) {
        document.getElementById('progressFill').style.width = `${pct}%`;
        document.getElementById('progressText').textContent = text;
      }

      download(canvas, name) {
        const a = document.createElement('a');
        a.download = `${name}-${Date.now()}.png`;
        a.href = canvas.toDataURL('image/png');
        a.click();
      }
    }

    document.addEventListener('DOMContentLoaded', () => new StrobeGenerator());
  </script>
</body>
</html>
